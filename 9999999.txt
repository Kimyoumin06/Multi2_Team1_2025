#include "api.h"        // í•„ìˆ˜: API í•¨ìˆ˜ ë° CMD_ ë§¤í¬ë¡œ

#include <stdio.h>      // í•„ìˆ˜: íŒŒì¼ ì…ì¶œë ¥

#include <stdlib.h>     // í•„ìˆ˜: ë¬¸ìì—´ ë³€í™˜, abs ë“±

#include <string.h>     // í•„ìˆ˜: ë¬¸ìì—´ ì²˜ë¦¬



// í•™ìƒì˜ ê³ ìœ ë²ˆí˜¸ë¥¼ ë°œê¸‰ë°›ì•„ ì €ì¥í•  ë³€ìˆ˜

int my_secret_key_b;



// =================================================================================================

// [PART 1] CSV íŒŒì‹± ë° ë°ì´í„° ë¡œë“œ

// =================================================================================================



typedef struct {

    int id;

    char name[50];

    char slot[10];

    int atk;

    int def;

    int hp;

    char curse[50];

    char key_frag[50];

} PuzzleItem;



#define MAX_ITEMS 100

#define MAX_LINE_LEN 256



static PuzzleItem p_items[MAX_ITEMS];

static int p_count = 0;

static const char* TARGET_CSV = "AI1-2_C_Final.csv";



static void load_csv_data(void) {

    FILE* fp = NULL;



    // [ìˆ˜ì •] fopen -> fopen_s (ì—ëŸ¬ ì½”ë“œ ë°˜í™˜ ë°©ì‹)

    errno_t err = fopen_s(&fp, TARGET_CSV, "r");



    if (err != 0 || fp == NULL) {

        printf("ERROR: [PlayerB] CSV file (%s) not found!\n", TARGET_CSV);

        return;

    }



    char line[MAX_LINE_LEN];

    // í—¤ë” ìŠ¤í‚µ

    if (!fgets(line, sizeof(line), fp)) { fclose(fp); return; }



    p_count = 0;

    while (fgets(line, sizeof(line), fp) && p_count < MAX_ITEMS) {

        PuzzleItem* it = &p_items[p_count];

        char temp[MAX_LINE_LEN];



        // [ìˆ˜ì •] strcpy -> strcpy_s

        strcpy_s(temp, sizeof(temp), line);



        char* next_token = NULL; // strtok_së¥¼ ìœ„í•œ ë¬¸ë§¥ í¬ì¸í„°



        // [ìˆ˜ì •] strtok -> strtok_s

        char* tok = strtok_s(temp, ",", &next_token);

        if (!tok) continue;

        it->id = atoi(tok);



        tok = strtok_s(NULL, ",", &next_token); if (!tok) continue;

        strcpy_s(it->name, sizeof(it->name), tok);



        tok = strtok_s(NULL, ",", &next_token); if (!tok) continue;

        strcpy_s(it->slot, sizeof(it->slot), tok);



        tok = strtok_s(NULL, ",", &next_token); if (!tok) continue;

        it->atk = atoi(tok);



        tok = strtok_s(NULL, ",", &next_token); if (!tok) continue;

        it->def = atoi(tok);



        tok = strtok_s(NULL, ",", &next_token); if (!tok) continue;

        it->hp = atoi(tok);



        tok = strtok_s(NULL, ",", &next_token); if (!tok) continue;

        strcpy_s(it->curse, sizeof(it->curse), tok);



        tok = strtok_s(NULL, ",", &next_token); if (!tok) continue;

        tok[strcspn(tok, "\r\n")] = 0; // ê°œí–‰ ì œê±°

        strcpy_s(it->key_frag, sizeof(it->key_frag), tok);



        p_count++;

    }

    fclose(fp);

    printf("SYSTEM: [PlayerB] Loaded %d items from %s\n", p_count, TARGET_CSV);

}



// =================================================================================================

// [PART 2] ë¬¸ì œ í’€ì´ í•¨ìˆ˜ë“¤ (5ë²ˆ, 6ë²ˆë§Œ ë‚¨ê¹€)

// =================================================================================================



// -----------------------------------------------------------------------------------------

// ğŸš¨ [ë‹´ë‹¹ íŒŒíŠ¸ 5ë²ˆ] ì›ê±°ë¦¬ ê³µê²© (fseek ìˆ˜ì •ë¨, ë³´ì•ˆ í•¨ìˆ˜ ì ìš©)

// -----------------------------------------------------------------------------------------

void solve_problem_5_range(int my_key) {

    char final_key[100] = "";

    int N = 0;



    // 1. "K"ê°€ í¬í•¨ëœ ì•„ì´í…œì˜ HP ì°¾ê¸°

    for (int i = 0; i < p_count; i++) {

        if (strstr(p_items[i].key_frag, "K") != NULL) {

            N = p_items[i].hp;

            break;

        }

    }



    // 2. íŒŒì¼ ì½ê¸° (ì¤‘ìš”: N-1 ìœ„ì¹˜ë¡œ ê°€ì•¼ ì •í™•íˆ ì½í˜!)

    if (N > 0) {

        FILE* fp = NULL;

        // [ìˆ˜ì •] fopen_s ì‚¬ìš©

        if (fopen_s(&fp, TARGET_CSV, "rb") == 0 && fp != NULL) {



            // ì»´í“¨í„°ëŠ” 0ë¶€í„° ì„¸ë¯€ë¡œ Në²ˆì§¸ ê¸€ìëŠ” ì¸ë±ìŠ¤ N-1ì„

            if (fseek(fp, N - 1, SEEK_SET) == 0) {

                char t[6] = { 0 };

                size_t r = fread(t, 1, 5, fp); // freadëŠ” í‘œì¤€ í•¨ìˆ˜ë¼ ë³´í†µ ê²½ê³  ì—†ìŒ

                t[r] = '\0';



                // [ìˆ˜ì •] sprintf -> sprintf_s

                sprintf_s(final_key, sizeof(final_key), "\"%s\"", t);

            }

            fclose(fp);

        }

    }



    // 3. ì œì¶œ ë° ê²°ê³¼ í™•ì¸

    attempt_skill_unlock(my_key, CMD_RANGE_ATTACK, final_key);



    if (is_skill_unlocked(my_key, CMD_RANGE_ATTACK))

        printf(">> [TEAM-BRAVO] ì›ê±°ë¦¬(RANGE) í•´ê¸ˆ ì„±ê³µ! ì •ë‹µ: [%s]\n", final_key);

    else

        printf(">> [TEAM-BRAVO] ì›ê±°ë¦¬(RANGE) í•´ê¸ˆ ì‹¤íŒ¨... ì‹œë„í•œ í‚¤: [%s]\n", final_key);

}



// -----------------------------------------------------------------------------------------

// ğŸš¨ [ë‹´ë‹¹ íŒŒíŠ¸ 6ë²ˆ] ì¶•ë³µ (strtok_s ì ìš©)

// -----------------------------------------------------------------------------------------

void solve_problem_6_bless(int my_key) {

    char final_key[100] = "";

    char combined[2000] = { 0 };



    // 1. Sword í¬í•¨ ì•„ì´í…œì˜ Key ì—°ê²°

    for (int i = 0; i < p_count; i++) {

        if (strstr(p_items[i].name, "Sword") != NULL) {

            // [ìˆ˜ì •] strcat -> strcat_s

            strcat_s(combined, sizeof(combined), p_items[i].key_frag);

        }

    }



    // 2. ê°€ì¥ ê¸´ í† í° ì°¾ê¸°

    char temp[2000];

    // [ìˆ˜ì •] strcpy -> strcpy_s

    strcpy_s(temp, sizeof(temp), combined);



    char* next_token = NULL; // strtok_sìš© í¬ì¸í„°



    // [ìˆ˜ì •] strtok -> strtok_s

    char* tok = strtok_s(temp, "*", &next_token);



    char* best = NULL;

    int max_len = -1;



    while (tok) {

        int len = (int)strlen(tok);

        // ê¸¸ì´ê°€ ë” ê¸¸ ë•Œë§Œ ê°±ì‹  (ê°™ìœ¼ë©´ ë¨¼ì € ë‚˜ì˜¨ ê²ƒ ìœ ì§€)

        if (len > max_len) {

            max_len = len;

            best = tok;

        }

        tok = strtok_s(NULL, "*", &next_token);

    }



    if (best) strcpy_s(final_key, sizeof(final_key), best);



    // 3. ì œì¶œ ë° ê²°ê³¼ í™•ì¸

    attempt_skill_unlock(my_key, CMD_BLESS, final_key);



    if (is_skill_unlocked(my_key, CMD_BLESS))

        printf(">> [TEAM-BRAVO] ì¶•ë³µ(BLESS) í•´ê¸ˆ ì„±ê³µ! ì •ë‹µ: [%s]\n", final_key);

    else

        printf(">> [TEAM-BRAVO] ì¶•ë³µ(BLESS) í•´ê¸ˆ ì‹¤íŒ¨... ì‹œë„í•œ í‚¤: [%s]\n", final_key);

}





// =================================================================================================

// [PART 3] AI ë¡œì§ êµ¬í˜„ë¶€

// =================================================================================================



static int get_dist(const Player* p1, const Player* p2) {

    return abs(get_player_x(p1) - get_player_x(p2)) + abs(get_player_y(p1) - get_player_y(p2));

}



int player_b_strategy(const Player* my_info, const Player* opponent_info) {

    int dist = get_dist(my_info, opponent_info);

    int mp = get_player_mp(my_info);

    int hp = get_player_hp(my_info);

    int my_x = get_player_x(my_info);

    int opp_x = get_player_x(opponent_info);

    int my_y = get_player_y(my_info);

    int opp_y = get_player_y(opponent_info);



    // 1. ìœ„ê¸° ê´€ë¦¬

    if (hp <= 2 && mp >= 1) {

        if (mp >= 2 && is_skill_unlocked(my_secret_key_b, CMD_HEAL_ALL)) return CMD_HEAL_ALL;

        return CMD_HEAL;

    }



    // 2. ê·¼ì ‘ ì „íˆ¬

    if (dist <= 1) {

        if (mp >= 2 && is_skill_unlocked(my_secret_key_b, CMD_STRIKE)) return CMD_STRIKE;

        return CMD_ATTACK;

    }



    // 3. ì›ê±°ë¦¬ ê²¬ì œ (ê±°ë¦¬ 2) -> ì›ê±°ë¦¬ ê³µê²©

    if (dist == 2 && mp >= 1) {

        if (is_skill_unlocked(my_secret_key_b, CMD_RANGE_ATTACK)) return CMD_RANGE_ATTACK;

    }



    // 4. ê°€ë¡œ/ì„¸ë¡œ ê³µê²©

    if (my_x == opp_x && mp >= 3 && is_skill_unlocked(my_secret_key_b, CMD_V_ATTACK)) return CMD_V_ATTACK;

    if (my_y == opp_y && mp >= 3 && is_skill_unlocked(my_secret_key_b, CMD_H_ATTACK)) return CMD_H_ATTACK;



    // 5. ì¶”ê²©

    if (my_x < opp_x) return CMD_RIGHT;

    if (my_x > opp_x) return CMD_LEFT;

    if (my_y < opp_y) return CMD_DOWN;

    if (my_y > opp_y) return CMD_UP;



    return CMD_REST;

}





// =================================================================================================

// [PART 4] ì‹œìŠ¤í…œ ì§„ì…ì 

// =================================================================================================



void student2_ai_entry() {

    // 1. ë°ì´í„° ë¡œë“œ

    load_csv_data();



    // 2. AI ë“±ë¡

    my_secret_key_b = register_player_ai("TEAM-BRAVO", player_b_strategy);



    printf("\n>>> TEAM-BRAVO ìŠ¤í‚¬ í•´ê¸ˆ ì‹œë„ ì¤‘ (ë‹´ë‹¹ íŒŒíŠ¸ 5, 6) <<<\n");



    // ----------------------------------------------------------------------------------

    // ì˜¤ì§ 5ë²ˆê³¼ 6ë²ˆë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.

    // ----------------------------------------------------------------------------------

    solve_problem_5_range(my_secret_key_b);

    solve_problem_6_bless(my_secret_key_b);



    printf("\n[í™•ì¸ìš©] ê²°ê³¼ í™•ì¸ í›„ ì—”í„° í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”...");

    getchar(); // ë©ˆì¶¤

}
